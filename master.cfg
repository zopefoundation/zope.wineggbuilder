# -*- python -*-
# ex: set syntax=python:

############################################################
# this should be a live copy of the master.cfg of the server
############################################################

import re
import time
import sys
import os.path
import subprocess
from twisted.python import log
from twisted.internet import reactor

from buildbot import locks

from buildbot.changes.svnpoller import SVNPoller, split_file_branches
from buildbot.steps import source
from buildbot.steps import shell
from buildbot.process import factory

from buildbot.process.base import Build
from buildbot.status import html
from buildbot.scheduler import Scheduler, Nightly, Triggerable, Periodic
from buildbot.steps.trigger import Trigger

# This is a sample buildmaster config file. It must be installed as
# 'master.cfg' in your buildmaster's base directory (although the filename
# can be changed with the --basedir option to 'mktap buildbot master').

# It has one job: define a dictionary named BuildmasterConfig. This
# dictionary has a variety of keys to control different aspects of the
# buildmaster. They are documented in docs/config.xhtml .


# This is the dictionary that the buildmaster pays attention to. We also use
# a shorter alias to save typing.
c = BuildmasterConfig = {}

####### DB URL

# This specifies what database buildbot uses to store change and scheduler
# state
c['db_url'] = "sqlite:///state.sqlite"

####### BUILDSLAVES

# the 'slaves' list defines the set of allowable buildslaves. Each element is
# a BuildSlave object, which is created with bot-name, bot-password.  These
# correspond to values given to the buildslave's mktap invocation.
from buildbot.buildslave import BuildSlave
c['slaves'] = [BuildSlave("local", "localpwd", max_builds=2)]

# to limit to two concurrent builds on a slave, use
#  c['slaves'] = [BuildSlave("bot1name", "bot1passwd", max_builds=2)]

FROMADDR = 'buildbot@winbot.zope.org'

######################################
# Custom helper classes

class SVN(source.SVN):

    show_revno = False # the LastChange step does it better

    def createSummary(self, log):
        log_text = log.getText()
        if self.show_revno:
            revno = self.extractRevno(log_text)
            if revno:
                self.descriptionDone = self.descriptionDone + ['r%s' % revno]

    def extractRevno(self, log_text):
        try:
            start_idx = log_text.rindex('At revision')
            end_idx = log_text.find('\n', start_idx)
        except ValueError:
            return None
        line = log_text[start_idx:end_idx]
        try:
            return re.findall('([0-9]+)', line)[0]
        except IndexError:
            return None


class LastChange(shell.ShellCommand):

    command = ['svn', 'log', '--limit', '1']
    name = 'svn-last-change'
    description = ['svn log --limit 1']
    descriptionDone = ['last change']

    # xxx hardcoded
    url_template = 'http://zope3.pov.lt/trac/log/zope.release?rev=%s'

    def createSummary(self, log):
        log_text = log.getText()
        revno = self.extractRevno(log_text)
        if revno:
            text = self.formatRevno(revno)
            self.descriptionDone = self.descriptionDone + [text]

    def formatRevno(self, revno):
        text = 'r%s' % revno
        if self.url_template:
            url = self.url_template % revno
            text = '<a class="revlink" href="%s">%s</a>' % (url, text)
        return text

    def extractRevno(self, log_text):
        for line in log_text.splitlines():
            if line.startswith('r'):
                return line.split()[0][1:]
        return None

class Test(shell.Test):

    started = None
    stopped = None

    tick_every = 10 # seconds

    def __init__(self, *args, **kw):
        shell.Test.__init__(self, *args, **kw)
        if 'name' in args:
            self.name = args['name']

    def start(self):
        shell.Test.start(self)
        self.started = time.time()
        reactor.callLater(self.tick_every, self.tick)

    def finished(self, results):
        if not self.stopped:
            self.stopped = time.time()
        shell.Test.finished(self, results)

    def tick(self):
        if not self.stopped:
            self.step_status.setText(self.describe(False))
            reactor.callLater(self.tick_every, self.tick)

    def describe(self, done=False):
        description = [self.name]
        if not done and self.started:
            running = time.time() - self.started
            description = [self.name, self.formatTime(running)]
        return description

    def createSummary(self, log):
        if not self.started:
            # just in case something async happens
            self.started = time.time()
        self.stopped = time.time()
        log_text = log.getText()
        totals = self.extractTotals(log_text)
        if totals:
            self.descriptionDone = self.descriptionDone + [totals]
        # the test runner lies about the time
        ## time_info = self.extractTime(log_text)
        time_info = self.formatTime(self.stopped - self.started)
        if time_info:
            self.descriptionDone = self.descriptionDone + [time_info]
        summary = self.extractSummary(log_text)
        if summary:
            self.addCompleteLog('summary', summary)

    def formatTime(self, seconds):
        return '%dm%02ds' % divmod(seconds, 60)

    def extractTotalsLine(self, log_text):
        try:
            start_idx = log_text.rindex('Total:')
            end_idx = log_text.find('\n', start_idx)
        except ValueError:
            return None
        return log_text[start_idx:end_idx]

    def extractTotals(self, log_text):
        totals_line = self.extractTotalsLine(log_text)
        if not totals_line:
            return None
        # Total: X tests, X failures, X errors in X minutes X.Y seconds.
        ntests, nfail, nerr = re.findall('([0-9.]+)', totals_line)[:3]
        return '%s/%s/%s' % (ntests, nfail, nerr)

    def extractTime(self, log_text):
        totals_line = self.extractTotalsLine(log_text)
        if not totals_line:
            return None
        # Total: X tests, X failures, X errors in [X minutes] X.Y seconds.
        time = totals_line.split(' in ')[-1]
        time = time.replace(' minutes ', 'm')
        time = time.replace(' seconds.', 's')
        time = re.sub('[.][0-9]+s', 's', time)
        return time

    def extractSummary(self, log_text):
        summary_idx = len(log_text)
        for interesting in ['Tests with errors:',
                            'Tests with failures:',
                            'Total:']:
            try:
                summary_idx = min(summary_idx,
                                  log_text.rindex('Tests with errors:'))
            except ValueError:
                pass
        return log_text[summary_idx:]

# Custom helper classes
######################################

######################################
# cleanup

def makeCleanfactory():

    f = factory.BuildFactory()

    f.addStep(shell.ShellCommand(
              command=r'python c:\buildmaster\cleanfolder.py c:\temp',
              haltOnFailure=True,
              name="clean temp",
              description="clean temp"))

    f.treeStableTimer = 300
    return f

def setupCleanupBuild(slow_lock):
    c['builders'].append({
        'name': 'cleanup',
        'slavename': 'local',
        'builddir': 'cleanup',
        'factory': makeCleanfactory(),
        'locks': [slow_lock],
    })

    c['schedulers'].append(Nightly(
                "Nightly cleanup", ['cleanup'], hour=[01],
                branch="trunk"))

# cleanup
######################################

######################################
# egg building

def makeEGGfactory():
    svn_url = 'svn://svn.zope.org/repos/main/Sandbox/adamg/zope.wineggbuilder/trunk'

    f = factory.BuildFactory()
    f.addStep(source.SVN(svnurl=svn_url, mode='clobber'))


    f.addStep(shell.Compile(name='bootstrap',
                command='python bootstrap.py',
                description=['bootstrapping'],
                descriptionDone=['bootstrap']))

    f.addStep(shell.Compile(name="buildout",
                command="bin\\buildout.exe",
                description=['buildout'],
                descriptionDone=['buildout']))

    f.addStep(shell.Compile(name="release eggs",
                command="bin\\build.exe -s rackspace.ini",
                description=['releasing eggs'],
                descriptionDone=['release eggs'],
                timeout=12000))

    f.treeStableTimer = 300
    return f

def setupEggBuild(slow_lock):
    c['builders'].append({
        'name': 'wineggbuilder',
        'slavename': 'local',
        'builddir': 'wineggbuilder',
        'factory': makeEGGfactory(),
        'locks': [slow_lock],
    })

    #c['schedulers'].append(Nightly(
    #            "Nightly egg build", ['wineggbuilder'], hour=01, minute=10,
    #            branch="trunk"))

    c['schedulers'].append(Periodic(
                "Periodic egg build", ['wineggbuilder'], periodicBuildTimer=1800,
                branch="trunk"))

# egg building
######################################

class Platform(object):
    python = ''
    buildout = ''
    name = ''
    title = ''

    def __init__(self, **kw):
        for k,v in kw.items():
            setattr(self, k, v)

PLATFORMS = dict(
    py_244_win32 = Platform(
        name='py_244_win32',
        title='Python 2.4.4 win32',
        python=r'c:\Python24_32\python.exe',
        buildout=r'bin\buildout.exe'),
    py_254_win32 = Platform(
        name='py_254_win32',
        title='Python 2.5.4 win32',
        python=r'c:\Python25_32\python.exe',
        buildout=r'bin\buildout.exe'),
    py_265_win32 = Platform(
        name='py_265_win32',
        title='Python 2.6.5 win32',
        python=r'c:\Python26_32\python.exe',
        buildout=r'bin\buildout.exe'),
    py_265_win64 = Platform(
        name='py_265_win64',
        title='Python 2.6.5 win64',
        python=r'c:\Python26_64\python.exe',
        buildout=r'bin\buildout.exe'),
    py_270_win32 = Platform(
        name='py_270_win32',
        title='Python 2.7.0 win32',
        python=r'c:\Python27_32\python.exe',
        buildout=r'bin\buildout.exe'),
    py_270_win64 = Platform(
        name='py_270_win64',
        title='Python 2.7.0 win64',
        python=r'c:\Python27_64\python.exe',
        buildout=r'bin\buildout.exe'),
)


#these python's have the right settings to be able to compile binary eggs
DEV_PLATFORMS = dict(
    py_244_win32 = Platform(
        name='py_244_win32',
        title='Python 2.4.4 win32',
        python=r'c:\Python24_32\python.exe',
        buildout=r'cmd /c c:\Python24_32\setupcompilerandexecute.bat bin\buildout.exe'),
    py_254_win32 = Platform(
        name='py_254_win32',
        title='Python 2.5.4 win32',
        python=r'c:\Python25_32\python.exe',
        buildout=r'cmd /c c:\Python25_32\setupcompilerandexecute.bat bin\buildout.exe'),
    py_265_win32 = Platform(
        name='py_265_win32',
        title='Python 2.6.5 win32',
        python=r'c:\Python26_32\python.exe',
        buildout=r'cmd /c c:\Python26_32\setupcompilerandexecute.bat bin\buildout.exe'),
    py_265_win64 = Platform(
        name='py_265_win64',
        title='Python 2.6.5 win64',
        python=r'c:\Python26_64\python.exe',
        buildout=r'cmd /c c:\Python26_64\setupcompilerandexecute.bat bin\buildout.exe'),
    py_270_win32 = Platform(
        name='py_270_win32',
        title='Python 2.7.0 win32',
        python=r'c:\Python27_32\python.exe',
        buildout=r'cmd /c c:\Python27_32\setupcompilerandexecute.bat bin\buildout.exe'),
    py_270_win64 = Platform(
        name='py_270_win64',
        title='Python 2.7.0 win64',
        python=r'c:\Python27_64\python.exe',
        buildout=r'cmd /c c:\Python27_64\setupcompilerandexecute.bat bin\buildout.exe'),
)

ZTK_DEV_PLATFORMS = DEV_PLATFORMS.copy()

del ZTK_DEV_PLATFORMS['py_270_win32']
del ZTK_DEV_PLATFORMS['py_270_win64']

######################################
# ZTK tests

def ztk_dev_builder(name, slavename, platform, locks):
    builddir = name.replace(' ', '_')
    f = factory.BuildFactory()
    f.addStep(SVN(
              svnurl="svn://svn.zope.org/repos/main/zopetoolkit/trunk",
              haltOnFailure=True,
              mode="update"))

    lc = LastChange()
    lc.url_template = 'http://zope3.pov.lt/trac/log/zopetoolkit?rev=%s'
    f.addStep(lc)

    #f.addStep(shell.ShellCommand(
    #          command=["/usr/bin/virtualenv", "--distribute", "-p", python, "--no-site-packages", "sandbox"],
    #          haltOnFailure=True,
    #          name="virtualenv",
    #          description="virtualenv"))
    f.addStep(shell.ShellCommand(
              command=[platform.python, "bootstrap.py"],
              haltOnFailure=True,
              name="bootstrap",
              description="bootstrap"))
    f.addStep(shell.ShellCommand(
              command=["sed", "-i", "s/svn+ssh/svn/", "ztk.cfg", "zopeapp.cfg"],
              haltOnFailure=True,
              name="disable ssh for svn",
              description="disable ssh for svn"))
    f.addStep(shell.ShellCommand(
              command="%s -c development.cfg" % platform.buildout,
              haltOnFailure=True,
              name="buildout",
              description="buildout",
              timeout=3600))
    f.addStep(shell.ShellCommand(
              command=["svn", "revert", "ztk.cfg", "zopeapp.cfg"],
              haltOnFailure=True,
              name="revert ztk.cfg and zopeapp.cfg",
              description="revert ztk.cfg and zopeapp.cfg"))
    f.addStep(Test(
              command=[r"bin\test-ztk.exe", "--exit-with-status", "-1"],
              haltOnFailure=False,
              name="test ztk",
              description="test ztk trunks"))
    f.addStep(Test(
              command=[r"bin\test-zopeapp.exe", "--exit-with-status", "-1"],
              haltOnFailure=False,
              name="test zopeapp trunks",
              description="test zopeapp"))
    return dict(name=name,
                slavename=slavename,
                builddir=builddir,
                factory=f,
                locks=locks)

def setupZTK_dev_tests(slow_lock):
    hour = 02
    minute = 01
    builders = []
    for pname in sorted(ZTK_DEV_PLATFORMS.keys()):
        platform = ZTK_DEV_PLATFORMS[pname]
        name = "ztk_dev %s" % platform.name
        builders.append(name)
        c['builders'].append(
            ztk_dev_builder(name, 'local', platform, [slow_lock]))

        c['schedulers'].append(
            Nightly( "%s_nightly" % name, [name], hour=hour, minute=minute))
        minute += 1

    c['status'].append(
      MailNotifier(mode="all",
               fromaddr=FROMADDR,
               extraRecipients=["zope-tests@zope.org"],
               sendToInterestedUsers=False,
               builders=builders,
               messageFormatter=message_formatter)
               )
# ZTK tests
######################################

######################################
# ZTK 1.0 tests

ZTK_10_PLATFORMS = PLATFORMS.copy()
del ZTK_10_PLATFORMS['py_270_win32']
del ZTK_10_PLATFORMS['py_270_win64']

def ztk_10_builder(name, slavename, platform, locks):
    builddir = name.replace(' ', '_')
    f = factory.BuildFactory()
    f.addStep(SVN(
              svnurl="svn://svn.zope.org/repos/main/zopetoolkit/trunk",
              haltOnFailure=True,
              mode="update"))

    lc = LastChange()
    lc.url_template = 'http://zope3.pov.lt/trac/log/zopetoolkit?rev=%s'
    f.addStep(lc)

    #f.addStep(shell.ShellCommand(
    #          command=["/usr/bin/virtualenv", "--distribute", "-p", python, "--no-site-packages", "sandbox"],
    #          haltOnFailure=True,
    #          name="virtualenv",
    #          description="virtualenv"))
    f.addStep(shell.ShellCommand(
              command=[platform.python, "bootstrap.py"],
              haltOnFailure=True,
              name="bootstrap",
              description="bootstrap"))
    f.addStep(shell.ShellCommand(
              command="%s" % platform.buildout,
              haltOnFailure=True,
              name="buildout",
              description="buildout",
              timeout=3600))
    f.addStep(Test(
              command=[r"bin\test-ztk.exe", "--exit-with-status", "-1"],
              haltOnFailure=False,
              name="test ztk",
              description="test ztk trunks",
              timeout=3600))
    f.addStep(Test(
              command=[r"bin\test-zopeapp.exe", "--exit-with-status", "-1"],
              haltOnFailure=False,
              name="test zopeapp trunks",
              description="test zopeapp",
              timeout=3600))
    return dict(name=name,
                slavename=slavename,
                builddir=builddir,
                factory=f,
                locks=locks)

def setupZTK_10_tests(slow_lock):
    hour = 02
    minute = 10
    builders = []
    for pname in sorted(ZTK_10_PLATFORMS.keys()):
        platform = ZTK_10_PLATFORMS[pname]
        name = "ztk_10 %s" % platform.name
        builders.append(name)
        c['builders'].append(
            ztk_10_builder(name, 'local', platform, [slow_lock]))

        c['schedulers'].append(
            Nightly( "%s_nightly" % name, [name], hour=hour, minute=minute))
        minute += 1

    c['status'].append(
      MailNotifier(mode="all",
               fromaddr=FROMADDR,
               extraRecipients=["zope-tests@zope.org"],
               sendToInterestedUsers=False,
               builders=builders,
               messageFormatter=message_formatter)
               )

# ZTK 1.0 tests
######################################

######################################
# zc.buildout

def zc_buildout_dev_builder(name, slavename, platform, locks):
    builddir = name.replace(' ', '_')
    f = factory.BuildFactory()
    f.addStep(SVN(
              svnurl="svn://svn.zope.org/repos/main/zc.buildout/trunk",
              haltOnFailure=True,
              mode="copy"))

    lc = LastChange()
    lc.url_template = 'http://zope3.pov.lt/trac/log/zc.buildout?rev=%s'
    f.addStep(lc)

    #f.addStep(shell.ShellCommand(
    #          command=["/usr/bin/virtualenv", "--distribute", "-p", python, "--no-site-packages", "sandbox"],
    #          haltOnFailure=True,
    #          name="virtualenv",
    #          description="virtualenv"))
    f.addStep(shell.ShellCommand(
              command=[platform.python, r"dev.py"],
              haltOnFailure=True,
              name="bootstrap",
              description="bootstrap"))
    #f.addStep(shell.ShellCommand(
    #          command="%s" % platform.buildout,
    #          haltOnFailure=True,
    #          name="buildout",
    #          description="buildout",
    #          timeout=3600))
    f.addStep(Test(
              command=[r"bin\test.exe", "--exit-with-status", "-1"],
              haltOnFailure=False,
              name="test",
              description="test trunk"))
    return dict(name=name,
                slavename=slavename,
                builddir=builddir,
                factory=f,
                locks=locks)

def setup_zc_buildout_dev_tests(slow_lock):
    hour = 02
    minute = 20
    builders = []
    for pname in sorted(PLATFORMS.keys()):
        platform = PLATFORMS[pname]
        name = "zc_buildout_dev %s" % platform.name
        builders.append(name)
        c['builders'].append(
            zc_buildout_dev_builder(name, 'local', platform, [slow_lock]))

        c['schedulers'].append(
            Nightly( "%s_nightly" % name, [name], hour=hour, minute=minute))
        minute += 1

    #c['status'].append(
    #  MailNotifier(mode="all",
    #           fromaddr=FROMADDR,
    #           extraRecipients=["zope-tests@zope.org"],
    #           sendToInterestedUsers=False,
    #           builders=builders,
    #           messageFormatter=message_formatter)
    #           )


# zc.buildout
######################################

######################################
# BlueBream

def bb_builder(name, slavename, platform, locks):
    builddir = name.replace(' ', '_')
    f = factory.BuildFactory()
    f.addStep(SVN(
              svnurl="svn://svn.zope.org/repos/main/bluebream/trunk",
              haltOnFailure=True,
              mode="copy"))

    lc = LastChange()
    lc.url_template = 'http://zope3.pov.lt/trac/log/bluebream?rev=%s'
    f.addStep(lc)

    #f.addStep(shell.ShellCommand(
    #          command=["/usr/bin/virtualenv", "--distribute", "-p", python, "--no-site-packages", "sandbox"],
    #          haltOnFailure=True,
    #          name="virtualenv",
    #          description="virtualenv"))

    f.addStep(shell.ShellCommand(
              command=[platform.python, r"bootstrap.py"],
              haltOnFailure=True,
              name="bootstrap",
              description="bootstrap"))
    f.addStep(shell.ShellCommand(
              command="cmd /c %s" % platform.buildout,
              haltOnFailure=True,
              name="buildout",
              description="buildout",
              timeout=3600))
    f.addStep(Test(
              command=[r"bin\test.exe", "-1", "--exit-with-status"]))
    return dict(name=name,
                slavename=slavename,
                builddir=builddir,
                factory=f,
                locks=locks)


def setup_BB_dev_tests(slow_lock):
    hour = 02
    minute = 30
    builders = []
    for pname in sorted(PLATFORMS.keys()):
        platform = PLATFORMS[pname]
        name = "BlueBream_dev %s" % platform.name
        c['builders'].append(
            bb_builder(name, 'local', platform, [slow_lock]))

        c['schedulers'].append(
            Nightly( "%s_nightly" % name, [name], hour=hour, minute=minute))
        minute += 1

    c['status'].append(
      MailNotifier(mode="all",
               fromaddr=FROMADDR,
               extraRecipients=["zope-tests@zope.org"],
               sendToInterestedUsers=False,
               builders=builders,
               messageFormatter=message_formatter)
               )

# BlueBream
######################################


######################################
# ZODB

ZODB_DEV_PLATFORMS = DEV_PLATFORMS.copy()
del ZODB_DEV_PLATFORMS['py_244_win32']

def ZODB_dev_builder(name, slavename, platform, locks):
    builddir = name.replace(' ', '_')
    f = factory.BuildFactory()
    f.addStep(SVN(
              svnurl="svn://svn.zope.org/repos/main/ZODB/trunk",
              haltOnFailure=True,
              mode="copy"))

    lc = LastChange()
    lc.url_template = 'http://zope3.pov.lt/trac/log/ZODB?rev=%s'
    f.addStep(lc)

    #f.addStep(shell.ShellCommand(
    #          command=["/usr/bin/virtualenv", "--distribute", "-p", python, "--no-site-packages", "sandbox"],
    #          haltOnFailure=True,
    #          name="virtualenv",
    #          description="virtualenv"))
    f.addStep(shell.ShellCommand(
              command=[platform.python, r"c:\buildmaster\bootstrap.py"],
              haltOnFailure=True,
              name="bootstrap",
              description="bootstrap"))
    f.addStep(shell.ShellCommand(
              command="%s" % platform.buildout,
              haltOnFailure=True,
              name="buildout",
              description="buildout",
              timeout=3600))
    f.addStep(Test(
              command=[r"bin\test.exe", "--exit-with-status", "-1"],
              haltOnFailure=False,
              name="test",
              description="test trunk"))
    return dict(name=name,
                slavename=slavename,
                builddir=builddir,
                factory=f,
                locks=locks)

def setup_ZODB_dev_tests(slow_lock):
    hour = 02
    minute = 40
    builders = []
    for pname in sorted(ZODB_DEV_PLATFORMS.keys()):
        platform = ZODB_DEV_PLATFORMS[pname]
        name = "ZODB_dev %s" % platform.name
        builders.append(name)
        c['builders'].append(
            ZODB_dev_builder(name, 'local', platform, [slow_lock]))

        c['schedulers'].append(
            Nightly( "%s_nightly" % name, [name], hour=hour, minute=minute))
        minute += 1

    c['status'].append(
      MailNotifier(mode="failing",
               fromaddr=FROMADDR,
               extraRecipients=["jim@zope.com", "agroszer@gmail.com"],
               sendToInterestedUsers=False,
               builders=builders,
               messageFormatter=message_formatter)
               )

    c['status'].append(
      MailNotifier(mode="all",
               fromaddr=FROMADDR,
               extraRecipients=["zope-tests@zope.org"],
               sendToInterestedUsers=False,
               builders=builders,
               messageFormatter=message_formatter)
               )

# ZODB
######################################

######################################
# mail status
from buildbot.status.html import WebStatus
from buildbot.status.mail import MailNotifier
from buildbot.status.builder import Results


def message_formatter(mode, name, build, results, master_status):
    """Provide a customized message to BuildBot's MailNotifier.
    The last 80 lines of the log are provided as well as the changes
    relevant to the build.
    """
    result = Results[results]

    limit_lines = 80
    text = list()

    # status required by zope-tests list
    # http://docs.zope.org/zopetoolkit/process/buildbots.html
    status = 'UNKNOWN'
    if result == 'success':
        status = 'OK'
    if result == 'failure':
        status = 'FAILED'

    #subject = '%s : %s / %s' % (status, master_status.getProjectName(), name)
    subject = '%s : %s / %s' % (status, "winbot", name)
    text.append(subject)
    text.append("Build: %s" % master_status.getURLForThing(build))
    text.append('\n')
    text.append("Build Reason: %s" % build.getReason())
    text.append('\n')

    source = ""
    ss = build.getSourceStamp()
    if ss.branch:
        source += "[branch %s] " % ss.branch
    if ss.revision:
        source +=  ss.revision
    else:
        source += "HEAD"
    if ss.patch:
        source += " (plus patch)"
    text.append("Build Source Stamp: %s" % source)
    text.append('\n')
    text.append("Blamelist: %s" % ", ".join(build.getResponsibleUsers()))
    text.append('\n')
    text.append("Buildbot: %s" % master_status.getBuildbotURL())
    return {
        'body': "\n".join(text),
        'type': 'plain',
        'subject': subject,
        }

# mail status
######################################


#let's stick with ONE test
slow_lock = locks.SlaveLock("cpu", maxCount=1)

c['schedulers'] = []
c['builders'] = []
c['status'] = []

setupCleanupBuild(slow_lock)

setupEggBuild(slow_lock)
setupZTK_dev_tests(slow_lock)
setupZTK_10_tests(slow_lock)
setup_zc_buildout_dev_tests(slow_lock)
setup_ZODB_dev_tests(slow_lock)
setup_BB_dev_tests(slow_lock)


#NO proxy via apache, so it can be kicked locally at least
c['status'].append(html.WebStatus(http_port=8009, allowForce=True))

#proxy THIS via apache
c['status'].append(html.WebStatus(http_port=8010, allowForce=False))


c['projectName'] = "Zope wineggbuilder and windows buildbot"
c['projectURL'] = "http://www.zope.org/"
c['buildbotURL'] = "http://winbot.zope.org/"
c['slavePortnum'] = "tcp:8989:interface=127.0.0.1"
